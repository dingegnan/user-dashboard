<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据管理系统</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 2px; font-size: 14px; }
        button:hover { background: #2563eb; }
        button.delete { background: #ef4444; }
        button.delete:hover { background: #dc2626; }
        button.edit { background: #f59e0b; }
        button.edit:hover { background: #d97706; }
        button.success { background: #10b981; }
        button.success:hover { background: #059669; }
        .hidden { display: none; }
        .tab { overflow: hidden; border-bottom: 1px solid #ccc; margin-bottom: 20px; }
        .tab button { background: transparent; color: black; border: none; border-bottom: 2px solid transparent; margin: 0 10px; }
        .tab button.active { border-bottom-color: #3b82f6; color: #3b82f6; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #e5e7eb; padding: 8px 12px; text-align: left; }
        th { background: #f9fafb; font-weight: 600; position: sticky; top: 0; }
        tr:hover { background: #f3f4f6; }
        .status-message { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status-success { background: #dcfce7; color: #166534; }
        .status-error { background: #fee2e2; color: #dc2626; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .form-group { margin: 10px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; }
        .pagination { display: flex; justify-content: center; margin: 20px 0; }
        .pagination button { margin: 0 5px; }
        .search-box { margin: 10px 0; padding: 8px; width: 300px; border: 1px solid #d1d5db; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>数据管理系统</h1>
            <div class="tab">
                <button class="tab-button active" onclick="openTab('data-view')">数据查看</button>
                <button class="tab-button" onclick="openTab('import')">数据导入</button>
                <button class="tab-button" onclick="openTab('export')">数据导出</button>
                <button class="tab-button" onclick="openTab('settings')">系统设置</button>
            </div>

            <!-- 数据查看标签页 -->
            <div id="data-view" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>数据列表</h3>
                    <div>
                        <input type="text" id="search-input" class="search-box" placeholder="搜索...">
                        <button onclick="refreshData()">刷新</button>
                        <button onclick="showAddModal()" class="success">添加记录</button>
                    </div>
                </div>
                <div id="data-table-container"></div>
                <div class="pagination" id="pagination"></div>
            </div>

            <!-- 数据导入标签页 -->
            <div id="import" class="tab-content hidden">
                <h3>数据导入</h3>
                <div class="form-group">
                    <label>选择文件 (CSV/JSON):</label>
                    <input type="file" id="file-input" accept=".csv,.json">
                </div>
                <div class="form-group">
                    <label>目标表名:</label>
                    <input type="text" id="table-name" placeholder="输入表名">
                </div>
                <button onclick="previewImport()">预览数据</button>
                <button onclick="executeImport()" class="success">执行导入</button>
                <div id="import-preview" style="margin-top: 20px;"></div>
            </div>

            <!-- 数据导出标签页 -->
            <div id="export" class="tab-content hidden">
                <h3>数据导出</h3>
                <div class="form-group">
                    <label>选择表:</label>
                    <select id="export-table-select">
                        <option value="">-- 选择表 --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>导出格式:</label>
                    <select id="export-format">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                <button onclick="exportData()">导出数据</button>
                <div id="export-result" style="margin-top: 20px;"></div>
            </div>

            <!-- 系统设置标签页 -->
            <div id="settings" class="tab-content hidden">
                <h3>系统设置</h3>
                <div class="form-group">
                    <label>Supabase URL:</label>
                    <input type="text" id="supabase-url" placeholder="https://umcobpyncbalzwquaers.supabase.co">
                </div>
                <div class="form-group">
                    <label>Supabase Anon Key:</label>
                    <input type="text" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtY29icHluY2JhbHp3cXVhZXJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NzMzMzMsImV4cCI6MjA3ODM0OTMzM30.VCZRjCDgVwNXu3e6Etmx6ppLBkIif_kbIE7IFRhU8OU">
                </div>
                <button onclick="saveSettings()" class="success">保存设置</button>
                <button onclick="testConnection()">测试连接</button>
                
                <div style="margin-top: 20px;">
                    <h4>数据库表列表</h4>
                    <div id="table-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑模态框 -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">添加记录</h3>
            <div id="modal-form"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeModal()">取消</button>
                <button onclick="saveRecord()" class="success">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 配置
        let currentTable = '取信异常设备清单';
        let currentPage = 1;
        const pageSize = 20;
        let allData = [];
        let tableSchema = {};

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadTableList();
        });

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.remove('hidden');
            event.target.classList.add('active');

            if (tabName === 'data-view') {
                loadTableData();
            } else if (tabName === 'export') {
                loadExportTables();
            }
        }

        // 数据操作函数
        async function loadTableData() {
            showStatus('正在加载数据...', 'success');
            
            try {
                const { data, error } = await supabase
                    .from(currentTable)
                    .select('*')
                    .range((currentPage - 1) * pageSize, currentPage * pageSize - 1);

                if (error) throw error;

                allData = data || [];
                renderTable(allData);
                renderPagination();
                showStatus(`已加载 ${allData.length} 条记录`, 'success');
                
            } catch (error) {
                showStatus('加载数据失败: ' + error.message, 'error');
            }
        }

        function renderTable(data) {
            if (!data || data.length === 0) {
                document.getElementById('data-table-container').innerHTML = '<p>暂无数据</p>';
                return;
            }

            const columns = Object.keys(data[0]);
            let html = `<table>
                <thead><tr>${columns.map(col => `<th>${col}</th>`).join('')}<th>操作</th></tr></thead>
                <tbody>`;

            data.forEach((row, index) => {
                html += `<tr>${columns.map(col => `<td>${row[col] || ''}</td>`).join('')}
                    <td>
                        <button class="edit" onclick="editRecord(${row.ID || index})">编辑</button>
                        <button class="delete" onclick="deleteRecord(${row.ID || index})">删除</button>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('data-table-container').innerHTML = html;
        }

        function renderPagination() {
            // 简化分页逻辑
            document.getElementById('pagination').innerHTML = `
                <button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">上一页</button>
                <span>第 ${currentPage} 页</span>
                <button onclick="changePage(${currentPage + 1})">下一页</button>
            `;
        }

        function changePage(page) {
            currentPage = page;
            loadTableData();
        }

        function refreshData() {
            currentPage = 1;
            loadTableData();
        }

        // 模态框操作
        function showAddModal() {
            document.getElementById('modal-title').textContent = '添加记录';
            document.getElementById('modal-form').innerHTML = generateForm();
            document.getElementById('edit-modal').style.display = 'block';
        }

        function editRecord(id) {
            const record = allData.find(row => row.ID === id);
            if (!record) return;

            document.getElementById('modal-title').textContent = '编辑记录';
            document.getElementById('modal-form').innerHTML = generateForm(record);
            document.getElementById('edit-modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function generateForm(record = {}) {
            if (allData.length === 0) return '<p>暂无字段信息</p>';
            
            const columns = Object.keys(allData[0]).filter(col => col !== 'ID' && col !== '创建时间' && col !== '更新时间');
            return columns.map(col => `
                <div class="form-group">
                    <label>${col}:</label>
                    <input type="text" id="field-${col}" value="${record[col] || ''}" placeholder="输入${col}">
                </div>
            `).join('');
        }

        async function saveRecord() {
            const columns = Object.keys(allData[0]).filter(col => col !== 'ID' && col !== '创建时间' && col !== '更新时间');
            const formData = {};
            
            columns.forEach(col => {
                formData[col] = document.getElementById(`field-${col}`).value;
            });

            try {
                let result;
                if (document.getElementById('modal-title').textContent === '添加记录') {
                    result = await supabase.from(currentTable).insert([formData]);
                } else {
                    // 编辑逻辑需要根据实际情况调整
                    result = await supabase.from(currentTable).update(formData);
                }

                if (result.error) throw result.error;

                showStatus('保存成功', 'success');
                closeModal();
                loadTableData();
                
            } catch (error) {
                showStatus('保存失败: ' + error.message, 'error');
            }
        }

        async function deleteRecord(id) {
            if (!confirm('确定要删除这条记录吗？')) return;

            try {
                const { error } = await supabase
                    .from(currentTable)
                    .delete()
                    .eq('ID', id);

                if (error) throw error;

                showStatus('删除成功', 'success');
                loadTableData();
                
            } catch (error) {
                showStatus('删除失败: ' + error.message, 'error');
            }
        }

        // 导入导出功能
        async function previewImport() {
            const fileInput = document.getElementById('file-input');
            const tableName = document.getElementById('table-name').value;
            
            if (!fileInput.files[0] || !tableName) {
                showStatus('请选择文件并输入表名', 'error');
                return;
            }

            const file = fileInput.files[0];
            const text = await file.text();
            let data;

            try {
                if (file.name.endsWith('.json')) {
                    data = JSON.parse(text);
                } else {
                    data = parseCSV(text);
                }

                document.getElementById('import-preview').innerHTML = `
                    <h4>预览数据 (前5条)</h4>
                    <pre>${JSON.stringify(data.slice(0, 5), null, 2)}</pre>
                    <p>总计: ${data.length} 条记录</p>
                `;
                
            } catch (error) {
                showStatus('文件解析错误: ' + error.message, 'error');
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim());
            
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim());
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] || '';
                });
                return obj;
            });
        }

        async function executeImport() {
            // 实现导入逻辑
            showStatus('导入功能开发中...', 'success');
        }

        async function exportData() {
            const tableName = document.getElementById('export-table-select').value;
            const format = document.getElementById('export-format').value;
            
            if (!tableName) {
                showStatus('请选择要导出的表', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.from(tableName).select('*');
                if (error) throw error;

                let content, mimeType, extension;
                
                if (format === 'json') {
                    content = JSON.stringify(data, null, 2);
                    mimeType = 'application/json';
                    extension = 'json';
                } else if (format === 'csv') {
                    content = convertToCSV(data);
                    mimeType = 'text/csv';
                    extension = 'csv';
                }

                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${tableName}-${new Date().toISOString().split('T')[0]}.${extension}`;
                a.click();
                URL.revokeObjectURL(url);
                
                showStatus(`数据已导出为 ${format.toUpperCase()} 格式`, 'success');
                
            } catch (error) {
                showStatus('导出失败: ' + error.message, 'error');
            }
        }

        function convertToCSV(data) {
            if (!data.length) return '';
            const headers = Object.keys(data[0]);
            const rows = data.map(row => 
                headers.map(header => `"${(row[header] || '').toString().replace(/"/g, '""')}"`).join(',')
            );
            return [headers.join(','), ...rows].join('\n');
        }

        // 系统设置
        function loadSettings() {
            const url = localStorage.getItem('supabase_url') || 'https://your-project.supabase.co';
            const key = localStorage.getItem('supabase_key') || 'your-anon-key';
            
            document.getElementById('supabase-url').value = url;
            document.getElementById('supabase-key').value = key;
            
            window.supabase = window.supabase.createClient(url, key);
        }

        function saveSettings() {
            const url = document.getElementById('supabase-url').value;
            const key = document.getElementById('supabase-key').value;
            
            localStorage.setItem('supabase_url', url);
            localStorage.setItem('supabase_key', key);
            
            window.supabase = window.supabase.createClient(url, key);
            showStatus('设置已保存', 'success');
        }

        async function testConnection() {
            try {
                const { data, error } = await supabase.from('取信异常设备清单').select('count').limit(1);
                if (error) throw error;
                showStatus('连接成功', 'success');
            } catch (error) {
                showStatus('连接失败: ' + error.message, 'error');
            }
        }

        async function loadTableList() {
            // 这里需要根据实际情况加载表列表
            // 简化实现，假设我们知道表名
            document.getElementById('table-list').innerHTML = `
                <ul>
                    <li>取信异常设备清单</li>
                    <li>其他表...</li>
                </ul>
            `;
        }

        function loadExportTables() {
            document.getElementById('export-table-select').innerHTML = `
                <option value="取信异常设备清单">取信异常设备清单</option>
                <option value="其他表">其他表</option>
            `;
        }

        function showStatus(message, type) {
            const statusElement = document.createElement('div');
            statusElement.className = `status-message status-${type}`;
            statusElement.textContent = message;
            
            const oldStatus = document.querySelector('.status-message');
            if (oldStatus) oldStatus.remove();
            
            document.querySelector('.container').insertBefore(statusElement, document.querySelector('.card'));
            
            setTimeout(() => {
                if (statusElement.parentNode) {
                    statusElement.remove();
                }
            }, 3000);
        }

        // 搜索功能
        document.getElementById('search-input').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm) {
                const filteredData = allData.filter(row => 
                    Object.values(row).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    )
                );
                renderTable(filteredData);
            } else {
                renderTable(allData);
            }
        });
    </script>
</body>
</html>
