<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据管理系统</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; line-height: 1.6; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; margin: 2px; font-size: 14px; }
        button:hover { background: #2563eb; }
        button.delete { background: #ef4444; }
        button.delete:hover { background: #dc2626; }
        button.edit { background: #f59e0b; }
        button.edit:hover { background: #d97706; }
        button.success { background: #10b981; }
        button.success:hover { background: #059669; }
        .hidden { display: none; }
        .tab { overflow: hidden; border-bottom: 1px solid #ccc; margin-bottom: 20px; }
        .tab button { background: transparent; color: black; border: none; border-bottom: 2px solid transparent; margin: 0 10px; }
        .tab button.active { border-bottom-color: #3b82f6; color: #3b82f6; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #e5e7eb; padding: 8px 12px; text-align: left; }
        th { background: #f9fafb; font-weight: 600; position: sticky; top: 0; }
        tr:hover { background: #f3f4f6; }
        .status-message { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status-success { background: #dcfce7; color: #166534; }
        .status-error { background: #fee2e2; color: #dc2626; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .form-group { margin: 10px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; }
        .pagination { display: flex; justify-content: center; margin: 20px 0; }
        .pagination button { margin: 0 5px; }
        .search-box { margin: 10px 0; padding: 8px; width: 300px; border: 1px solid #d1d5db; border-radius: 4px; }
        .config-section { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div id="config-section" class="card config-section">
            <h3>Supabase 配置</h3>
            <div class="form-group">
                <label>Supabase URL:</label>
                <input type="text" id="supabase-url" placeholder="https://umcobpyncbalzwquaers.supabase.co" style="width: 400px;">
            </div>
            <div class="form-group">
                <label>Supabase Anon Key:</label>
                <input type="text" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtY29icHluY2JhbHp3cXVhZXJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NzMzMzMsImV4cCI6MjA3ODM0OTMzM30.VCZRjCDgVwNXu3e6Etmx6ppLBkIif_kbIE7IFRhU8OU" style="width: 400px;">
            </div>
            <div class="form-group">
                <label>表名:</label>
                <input type="text" id="table-name" value="取信异常设备清单" placeholder="输入表名">
            </div>
            <button onclick="initSupabase()" class="success">初始化连接</button>
            <button onclick="testConnection()">测试连接</button>
            <div id="config-status" style="margin-top: 10px;"></div>
        </div>

        <div id="app-section" class="card hidden">
            <h1>数据管理系统</h1>
            <div class="tab">
                <button class="tab-button active" onclick="openTab('data-view')">数据查看</button>
                <button class="tab-button" onclick="openTab('import')">数据导入</button>
                <button class="tab-button" onclick="openTab('export')">数据导出</button>
                <button class="tab-button" onclick="openTab('manage')">表管理</button>
            </div>

            <!-- 数据查看标签页 -->
            <div id="data-view" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>数据列表</h3>
                    <div>
                        <input type="text" id="search-input" class="search-box" placeholder="搜索...">
                        <button onclick="refreshData()">刷新</button>
                        <button onclick="showAddModal()" class="success">添加记录</button>
                    </div>
                </div>
                <div id="data-table-container"></div>
                <div class="pagination" id="pagination"></div>
            </div>

            <!-- 数据导入标签页 -->
            <div id="import" class="tab-content hidden">
                <h3>数据导入</h3>
                <div class="form-group">
                    <label>选择文件 (CSV/JSON):</label>
                    <input type="file" id="file-input" accept=".csv,.json">
                </div>
                <button onclick="previewImport()">预览数据</button>
                <button onclick="executeImport()" class="success">执行导入</button>
                <div id="import-preview" style="margin-top: 20px;"></div>
            </div>

            <!-- 数据导出标签页 -->
            <div id="export" class="tab-content hidden">
                <h3>数据导出</h3>
                <div class="form-group">
                    <label>导出格式:</label>
                    <select id="export-format">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
                <button onclick="exportData()">导出数据</button>
                <div id="export-result" style="margin-top: 20px;"></div>
            </div>

            <!-- 表管理标签页 -->
            <div id="manage" class="tab-content hidden">
                <h3>表管理</h3>
                <button onclick="createSampleTable()">创建示例表</button>
                <button onclick="clearAllData()" class="delete">清空所有数据</button>
                <div id="table-info" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑模态框 -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">添加记录</h3>
            <div id="modal-form"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeModal()">取消</button>
                <button onclick="saveRecord()" class="success">保存</button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let supabase = null;
        let currentTable = '取信异常设备清单';
        let currentPage = 1;
        const pageSize = 10;
        let allData = [];
        let tableSchema = [];

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
        });

        // 配置函数
        function loadConfig() {
            const savedUrl = localStorage.getItem('supabase_url');
            const savedKey = localStorage.getItem('supabase_key');
            const savedTable = localStorage.getItem('current_table');
            
            if (savedUrl) document.getElementById('supabase-url').value = savedUrl;
            if (savedKey) document.getElementById('supabase-key').value = savedKey;
            if (savedTable) {
                document.getElementById('table-name').value = savedTable;
                currentTable = savedTable;
            }
        }

        function saveConfig() {
            const url = document.getElementById('supabase-url').value;
            const key = document.getElementById('supabase-key').value;
            const table = document.getElementById('table-name').value;
            
            localStorage.setItem('supabase_url', url);
            localStorage.setItem('supabase_key', key);
            localStorage.setItem('current_table', table);
            currentTable = table;
        }

        function initSupabase() {
            saveConfig();
            
            const url = document.getElementById('supabase-url').value;
            const key = document.getElementById('supabase-key').value;
            
            if (!url || !key) {
                showConfigStatus('请填写 URL 和 Key', 'error');
                return;
            }

            try {
                supabase = window.supabase.createClient(url, key);
                showConfigStatus('Supabase 客户端已初始化', 'success');
                document.getElementById('app-section').classList.remove('hidden');
                testConnection();
            } catch (error) {
                showConfigStatus('初始化失败: ' + error.message, 'error');
            }
        }

        async function testConnection() {
            if (!supabase) {
                showConfigStatus('请先初始化 Supabase', 'error');
                return;
            }

            try {
                showConfigStatus('正在测试连接...', 'success');
                
                // 测试查询
                const { data, error } = await supabase
                    .from(currentTable)
                    .select('*')
                    .limit(1);

                if (error) {
                    if (error.message.includes('does not exist')) {
                        showConfigStatus(`表 "${currentTable}" 不存在，请先创建表`, 'error');
                    } else {
                        throw error;
                    }
                } else {
                    showConfigStatus('连接成功! 可以开始使用系统', 'success');
                    loadTableData();
                }
            } catch (error) {
                showConfigStatus('连接失败: ' + error.message, 'error');
                console.error('Connection error:', error);
            }
        }

        function showConfigStatus(message, type) {
            const statusElement = document.getElementById('config-status');
            statusElement.innerHTML = `<div class="status-${type}" style="padding: 10px; border-radius: 5px;">${message}</div>`;
        }

        // 数据操作函数
        async function loadTableData() {
            if (!supabase) {
                showStatus('请先配置 Supabase 连接', 'error');
                return;
            }

            showStatus('正在加载数据...', 'success');
            
            try {
                const { data, error } = await supabase
                    .from(currentTable)
                    .select('*')
                    .range((currentPage - 1) * pageSize, currentPage * pageSize - 1)
                    .order('id', { ascending: false });

                if (error) throw error;

                allData = data || [];
                renderTable(allData);
                renderPagination();
                showStatus(`已加载 ${allData.length} 条记录`, 'success');
                
            } catch (error) {
                showStatus('加载数据失败: ' + error.message, 'error');
                console.error('Load data error:', error);
            }
        }

        function renderTable(data) {
            const container = document.getElementById('data-table-container');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<p>暂无数据</p>';
                return;
            }

            // 获取表头
            const columns = Object.keys(data[0]);
            tableSchema = columns;

            let html = `
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                ${columns.map(col => `<th>${col}</th>`).join('')}
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach((row) => {
                html += `
                    <tr>
                        ${columns.map(col => `<td>${formatCellValue(row[col])}</td>`).join('')}
                        <td>
                            <button class="edit" onclick="editRecord(${row.id})">编辑</button>
                            <button class="delete" onclick="deleteRecord(${row.id})">删除</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function formatCellValue(value) {
            if (value === null || value === undefined) return '';
            if (typeof value === 'object') return JSON.stringify(value);
            return value.toString();
        }

        function renderPagination() {
            // 简化分页
            document.getElementById('pagination').innerHTML = `
                <button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">上一页</button>
                <span>第 ${currentPage} 页</span>
                <button onclick="changePage(${currentPage + 1})">下一页</button>
            `;
        }

        // 其他函数保持不变（模态框、导入导出等）
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.remove('hidden');
            event.target.classList.add('active');

            if (tabName === 'data-view') {
                loadTableData();
            }
        }

        function changePage(page) {
            currentPage = page;
            loadTableData();
        }

        function refreshData() {
            currentPage = 1;
            loadTableData();
        }

        function showAddModal() {
            document.getElementById('modal-title').textContent = '添加记录';
            document.getElementById('modal-form').innerHTML = generateForm();
            document.getElementById('edit-modal').style.display = 'block';
        }

        function editRecord(id) {
            const record = allData.find(row => row.id === id);
            if (!record) return;

            document.getElementById('modal-title').textContent = '编辑记录';
            document.getElementById('modal-form').innerHTML = generateForm(record);
            document.getElementById('edit-modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function generateForm(record = {}) {
            if (tableSchema.length === 0) return '<p>暂无字段信息</p>';
            
            const columns = tableSchema.filter(col => col !== 'id' && col !== 'created_at' && col !== 'updated_at');
            return columns.map(col => `
                <div class="form-group">
                    <label>${col}:</label>
                    <input type="text" id="field-${col}" value="${record[col] || ''}" placeholder="输入 ${col}">
                </div>
            `).join('');
        }

        async function saveRecord() {
            const columns = tableSchema.filter(col => col !== 'id' && col !== 'created_at' && col !== 'updated_at');
            const formData = {};
            
            columns.forEach(col => {
                formData[col] = document.getElementById(`field-${col}`).value;
            });

            try {
                let result;
                if (document.getElementById('modal-title').textContent === '添加记录') {
                    result = await supabase.from(currentTable).insert([formData]);
                } else {
                    const recordId = allData.find(row => 
                        Object.keys(formData).some(key => row[key] === formData[key])
                    )?.id;
                    if (recordId) {
                        result = await supabase.from(currentTable).update(formData).eq('id', recordId);
                    }
                }

                if (result.error) throw result.error;

                showStatus('保存成功', 'success');
                closeModal();
                loadTableData();
                
            } catch (error) {
                showStatus('保存失败: ' + error.message, 'error');
            }
        }

        async function deleteRecord(id) {
            if (!confirm('确定要删除这条记录吗？')) return;

            try {
                const { error } = await supabase
                    .from(currentTable)
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showStatus('删除成功', 'success');
                loadTableData();
                
            } catch (error) {
                showStatus('删除失败: ' + error.message, 'error');
            }
        }

        function showStatus(message, type) {
            // 创建或更新状态消息
            let statusElement = document.querySelector('.status-message');
            if (!statusElement) {
                statusElement = document.createElement('div');
                statusElement.className = 'status-message';
                document.querySelector('.container').insertBefore(statusElement, document.querySelector('.card'));
            }
            
            statusElement.className = `status-message status-${type}`;
            statusElement.textContent = message;
            
            setTimeout(() => {
                if (statusElement.parentNode) {
                    statusElement.remove();
                }
            }, 3000);
        }

        // 表管理函数
        async function createSampleTable() {
            if (!supabase) {
                showStatus('请先初始化 Supabase', 'error');
                return;
            }

            try {
                showStatus('正在创建示例表...', 'success');
                
                // 这里需要在实际使用中通过 Supabase SQL 编辑器创建表
                // 暂时使用插入数据的方式
                const sampleData = {
                    站址名称: '示例站址',
                    设备名称: '示例设备',
                    省: '广东省',
                    市: '广州市',
                    缺失信号量: 5,
                    站址状态: '正常'
                };

                const { error } = await supabase
                    .from(currentTable)
                    .insert([sampleData]);

                if (error) throw error;

                showStatus('示例数据添加成功', 'success');
                loadTableData();
                
            } catch (error) {
                showStatus('创建失败: ' + error.message, 'error');
            }
        }

        async function clearAllData() {
            if (!confirm('确定要清空所有数据吗？此操作不可逆！')) return;

            try {
                const { error } = await supabase
                    .from(currentTable)
                    .delete()
                    .neq('id', 0); // 删除所有数据

                if (error) throw error;

                showStatus('数据已清空', 'success');
                loadTableData();
                
            } catch (error) {
                showStatus('清空失败: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
